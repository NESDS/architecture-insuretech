# Задание 3. Переход на Event-Driven архитектуру

## Текущие проблемы

| Проблема | Описание |
|----------|----------|
| Синхронные запросы к ins-product-aggregator | core-app опрашивает каждые 15 мин, ins-comp-settlement — раз в сутки |
| Синхронный запрос оформленных страховок | ins-comp-settlement запрашивает core-app раз в сутки по REST |
| Задержки при агрегации | Время ответа = максимальное время среди всех 5 компаний |
| Каскадные отказы | Сбой одной страховой компании влияет на весь запрос |

## Риски при росте (добавление ещё 5 страховых компаний)

| Риск | Влияние |
|------|---------|
| Увеличение времени ответа | 10 компаний вместо 5 → время агрегации вырастет вдвое |
| Рост вероятности ошибок | Вероятность сбоя удваивается |
| Неактуальность данных | Polling каждые 15 минут → данные устаревают |
| Потеря данных при сбое | При падении core-app данные не дойдут до ins-comp-settlement |

## Решение: Event-Driven архитектура

### Взаимодействия, переведённые на Event-Streaming

| Связь | Было | Стало |
|-------|------|-------|
| ins-product-aggregator → core-app | REST (polling 15 мин) | Kafka: топик `products-updated` |
| ins-product-aggregator → ins-comp-settlement | REST (polling 1 раз/сутки) | Kafka: топик `products-updated` |
| core-app → ins-comp-settlement | REST (запрос 1 раз/сутки) | Kafka: топик `insurance-issued` |

### Transactional Outbox

**Решение: применять**

| Параметр | Значение |
|----------|----------|
| Где применяется | core-app (при оформлении страховки), ins-product-aggregator (при обновлении продуктов) |
| Причина | Гарантия согласованности между записью в БД и отправкой события |
| Реализация | Таблица `outbox` + Debezium CDC для доставки в Kafka |

### Преимущества решения

- **Устранение polling** — данные доставляются сразу при изменении
- **Отказоустойчивость** — сбой одного сервиса не блокирует другие
- **Масштабируемость** — Kafka легко справляется с ростом нагрузки
- **Гарантия доставки** — Transactional Outbox исключает потерю событий

## Файлы

- `diagram_event_driven.drawio` — обновлённая диаграмма контейнеров с Kafka


