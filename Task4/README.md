# Задание 4. Проектирование продажи ОСАГО

## Бизнес-требования

| Требование | Значение |
|------------|----------|
| Отображение предложений | В реальном времени по мере получения от страховых |
| Максимальное время ожидания | 60 секунд |
| Пиковая нагрузка | 2500 одновременных пользователей |
| API страховых компаний | REST: создать заявку + получить предложение |

## Архитектурные решения

### 1. osago-aggregator — требуется своё хранилище

**Решение: Да, osago-aggregator требует собственную БД (osago-db)**

| Причина | Пояснение |
|---------|-----------|
| Хранение заявок | Сохранение данных заявки для повторного опроса страховых |
| Отслеживание статусов | Для каждой страховой компании — статус опроса (pending/received/timeout) |
| Хранение предложений | Кэширование полученных предложений до отправки клиенту |
| Отказоустойчивость | При перезапуске сервиса данные не теряются |
| Несколько экземпляров | Все реплики сервиса используют общую БД |

### 2. API osago-aggregator для core-app

**Решение: REST API**

```
POST /osago/requests
Request:
{
  "requestId": "uuid",
  "clientId": "uuid",
  "vehicleData": {...},
  "ownerData": {...}
}
Response:
{
  "requestId": "uuid",
  "status": "accepted"
}
```

Возврат ответа происходит синхронно (подтверждение приёма заявки), а предложения доставляются асинхронно через Kafka.

### 3. Интеграция core-app ↔ osago-aggregator

**Решение: REST + Kafka**

| Направление | Протокол | Описание |
|-------------|----------|----------|
| core-app → osago-aggregator | REST | Создание заявки на ОСАГО |
| osago-aggregator → core-app | Kafka | Асинхронная доставка предложений (топик `osago-proposals`) |

**Почему Kafka, а не REST callback:**
- Гарантированная доставка сообщений
- Несколько экземпляров core-app могут получать события
- Отсутствие проблем с сетевой связностью при callback
- Возможность повторной обработки при сбоях

### 4. Интеграция Web App ↔ core-app

**Решение: REST + WebSocket**

| Направление | Протокол | Описание |
|-------------|----------|----------|
| Web App → core-app | REST | Создание заявки на ОСАГО |
| core-app → Web App | **WebSocket** | Push предложений в реальном времени |

**Почему WebSocket:**
- Предложения должны отображаться сразу при получении (бизнес-требование)
- Polling не подходит — создаёт лишнюю нагрузку
- Server-Sent Events (SSE) — альтернатива, но WebSocket более универсален

**Учёт нескольких экземпляров:**
- Используется Redis Pub/Sub или Kafka для синхронизации WebSocket-сессий между экземплярами core-app
- Sticky sessions на уровне Load Balancer для WebSocket-соединений

### 5. Паттерны отказоустойчивости

| Паттерн | Где применяется | Параметры |
|---------|-----------------|-----------|
| **Timeout** | osago-aggregator → страховые | 60 секунд (согласно требованиям) |
| **Timeout** | core-app → osago-aggregator | 5 секунд (для синхронного REST-вызова) |
| **Retry** | osago-aggregator → страховые | 3 попытки с exponential backoff |
| **Circuit Breaker** | osago-aggregator → страховые | Отдельный для каждой страховой компании |
| **Rate Limiter** | Партнёры → core-app | Защита от перегрузки B2B-клиентами |
| **Rate Limiter** | Web App → core-app | Защита от DDoS и спама заявками |

### 6. Поток данных при оформлении ОСАГО

```
1. Клиент → Web App: Заполняет заявку на ОСАГО
2. Web App → core-app (REST): POST /osago
3. core-app → osago-aggregator (REST): POST /osago/requests
4. osago-aggregator → страховые (REST): Параллельная отправка во все компании
5. osago-aggregator: Polling каждой страховой каждые 3-5 сек
6. При получении предложения:
   osago-aggregator → Kafka: Publish osago-proposals
7. core-app ← Kafka: Consume osago-proposals
8. core-app → Web App (WebSocket): Push предложения клиенту
9. Клиент видит предложение на экране в реальном времени
```

### 7. Учёт нескольких экземпляров

| Сервис | Решение |
|--------|---------|
| osago-aggregator | Общая БД (osago-db), Kafka consumer group для балансировки |
| core-app | Redis Pub/Sub для синхронизации WebSocket между экземплярами |
| Kafka consumers | Consumer groups обеспечивают балансировку нагрузки |

## Файлы

- `diagram_osago.drawio` — обновлённая диаграмма контейнеров с ОСАГО функционалом

## Изменения относительно Task3

| Элемент | Изменение |
|---------|-----------|
| osago-aggregator | ✅ Добавлен новый сервис |
| osago-db | ✅ Добавлена новая БД |
| Kafka topic osago-proposals | ✅ Добавлен новый топик |
| WebSocket core-app → Web App | ✅ Добавлена новая интеграция |
| Паттерны отказоустойчивости | ✅ Добавлены на схему |

